{"componentChunkName":"component---node-modules-pauliescanlon-gatsby-theme-terminal-src-layouts-source-layout-js","path":"/posts/formiqr-part2-email-cloud-function/","result":{"data":{"mdx":{"id":"3326a726-7f3f-56c6-96b1-ed12705c9fbf","body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Sending personalized email with dynamic QR from cloud function\",\n  \"tags\": [\"email\", \"Firebase\", \"cloud functions\"],\n  \"date\": \"2019-04-22T00:00:00.000Z\",\n  \"author\": \"Akshay Ashok\"\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"This is the second part of the series named Building formiQR.\"), mdx(\"p\", null, \"By following the previous article, you may have a similar structure of Realtime Database,as\"), mdx(\"p\", null, mdx(\"img\", _extends({\n    parentName: \"p\"\n  }, {\n    \"src\": \"https://res.cloudinary.com/akshay090/image/upload/v1597567353/Portfolio_Assets/firebase1_llkvea.png\",\n    \"alt\": \"Firebase structure\"\n  }))), mdx(\"p\", null, \"Note: You would not be having the atEvent and count node, as we would be writing code for them in other sections of the blog series.\"), mdx(\"p\", null, \"So looking at our maker node or let say registered users, we have their name and email id. Now we need to set a cloud function, which would be able to get the name and email, at on create trigger on the node and send personalized email to them.\"), mdx(\"p\", null, \"A small brief about firebase cloud function, if you are new to it, Cloud Functions for Firebase lets you automatically run backend code in response to events triggered by Firebase features.\"), mdx(\"p\", null, \"Here is a \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://firebase.google.com/docs/functions/get-started\"\n  }), \"post to get started\"), \" with firebase cloud functions, you can follow it upto step 4 and then we need to add the following code to the index.js\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"language-js\"\n  }), \"//index.js\\nconst functions = require(\\\"firebase-functions\\\");\\nconst nodemailer = require(\\\"nodemailer\\\");\\nconst fs = require(\\\"fs\\\");\\nconst path = require(\\\"path\\\");\\n\\n// The Firebase Admin SDK to access the Firebase Realtime Database.\\nconst admin = require(\\\"firebase-admin\\\");\\nadmin.initializeApp();\\n\\nconst gmailEmail = functions.config().gmail.email;\\nconst gmailPassword = functions.config().gmail.password;\\nconst mailTransport = nodemailer.createTransport({\\n  service: \\\"gmail\\\",\\n  auth: {\\n    user: gmailEmail,\\n    pass: gmailPassword,\\n  },\\n});\\n\\nexports.mailFxn = functions.database\\n  .ref(\\\"/maker/{id}\\\")\\n  .onCreate((snapshot, context) => {\\n    // Grab the current value of what was written to the Realtime Database.\\n    const makers = snapshot.val();\\n    console.log(makers.name);\\n    console.log(makers.email);\\n\\n    const makerID = context.params.id;\\n\\n    //firebase functions:config:set gmail.email=myemailID@gmail.com gmail.password=Mypassword\\n    //To set email and password\\n\\n    //To view the set email and pass firebase functions:config:get\\n\\n    sendEmail(makers, makerID);\\n\\n    return null;\\n  });\\n\\nfunction sendEmail(makers, makerID) {\\n  //http://www.google.com/accounts/DisplayUnlockCaptcha\\n  //https://myaccount.google.com/lesssecureapps\\n  //This link is important to enable accesses to google account\\n\\n  var UNIQUE_NAME = makers.name;\\n  // var UNIQUE_ID = makerID;\\n\\n  var UNIQUE_QR = `https://chart.googleapis.com/chart?chs=150x150&cht=qr&chl=${\\n    +makerID + 1000\\n  }`;\\n\\n  var filePath = path.join(__dirname, \\\"templates/makerEmail.html\\\");\\n\\n  fs.readFile(filePath, { encoding: \\\"utf-8\\\" }, function (err, data) {\\n    data = data.toString();\\n    data = data.replace(/##UNIQUE_NAME/g, UNIQUE_NAME);\\n    // data = data.replace(/##UNIQUE_ID/g, UNIQUE_ID);\\n    data = data.replace(/##UNIQUE_QR/g, UNIQUE_QR);\\n\\n    var mailOptions = {\\n      from: '\\\"MakerEvent\\\" <noreply@firebase.com>', // sender address\\n      to: makers.email, // list of receivers\\n      subject: \\\"Thank You For Registration\\\", // Subject line\\n      html: data, // html body\\n    };\\n\\n    try {\\n      mailTransport.sendMail(mailOptions);\\n    } catch (error) {\\n      console.error(\\\"There was an error while sending the email:\\\", error);\\n\\n      // errorEmails = functions.database.ref(`/emailError/${makerID}`).set({\\n      //   email: makers.email\\n      // })\\n    }\\n\\n    return console.log(\\n      `Sending mail to ${makers.name} with stamp ${makers.stamp}`\\n    );\\n  });\\n}\\n\\n//To deploy firebase deploy --only functions:mailFxn\\n\")), mdx(\"p\", null, \"You can go through the code, its very straightforward to understand, and the important details are in the comment section.\"), mdx(\"p\", null, \"Before we proceed further, we need to make an email template, which we would be using to send personalized emails to our event attendees.\"), mdx(\"p\", null, \"To generate an awesome email template, you can use \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://stripo.email\"\n  }), \"https://stripo.email\"), \" this is by far the best website I found to make email templates. PS: I am not sponsored by stripo, it's just that they are really awesome.\"), mdx(\"p\", null, \"After designing your email template, export it as HTML and add it under functions/templates/makerEmail.html\"), mdx(\"p\", null, \"Don't forget to add tags, which we would be replacing dynamically, like ##UNIQUE_NAME or ##UNIQUE_QR.\"), mdx(\"p\", null, \"This method of using data.replace(/##UNIQUE_NAME/g, \\\"MyNameHere\\\"); is the most easiest method I found to generate personalized emails.\"), mdx(\"p\", null, \"Finally we can deploy this cloud function, for that run \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"firebase deploy --only functions:mailFxn\")), mdx(\"p\", null, \"Now when ever a node is created, the cloud function would automatically send them the personalized emails. Wait, how to send email to the ones already present in firebase realtime database,before we added this cloud function.\"), mdx(\"p\", null, \"For that delete the nodes for the one already present, before adding the cloud function and press the SYNC button in the google sheet which we added at the end of previous article. That would recreate the onCreate Trigger and the cloud function would do the work.\"), mdx(\"p\", null, \"So finally its over, see you in the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"/posts/formiqr-part3-counter-cloud-function\"\n  }), \"next post\"), \" where we will discuss how to add a counter cloud function to keep track of attendees count.\"));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"This is the second part of the series named Building formiQR. By following the previous article, you may have a similar structure ofâ€¦","timeToRead":2,"wordCount":{"words":417},"frontmatter":{"title":"Sending personalized email with dynamic QR from cloud function","tags":["email","Firebase","cloud functions"],"date":"2019-04-22T00:00:00.000Z","dateModified":null,"author":"Akshay Ashok","status":null,"isPrivate":null,"url":null,"misc":null,"pinned":null,"featuredImage":null,"featuredImageUrl":null,"embeddedImages":null,"embeddedImageUrls":null},"fields":{"slug":"/posts/formiqr-part2-email-cloud-function/","owner":"source","parent":"posts"}}},"pageContext":{"id":"3326a726-7f3f-56c6-96b1-ed12705c9fbf","prev":{"frontmatter":{"title":"How to build formiQR - Event management with Google Forms and Cloud Function","status":null},"fields":{"slug":"/posts/formiqr/"}},"next":{"frontmatter":{"title":"A cloud function to implement a counter","status":null},"fields":{"slug":"/posts/formiqr-part3-counter-cloud-function/"}},"parent":"posts"}},"staticQueryHashes":["1095393795","1402550803","1469902088"]}